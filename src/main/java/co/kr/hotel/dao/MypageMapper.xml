<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC	"-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="co.kr.hotel.dao.MypageDAO">

	<select id="tomemberboardlist" resultType="co.kr.hotel.dto.MypageDTO">
		select * from board order by board_orinum desc , re_num asc;
	</select>
	
	
	<select id="mypage2Reservelist" resultType="co.kr.hotel.dto.ReserveDTO">
		
		select reserve_idx,mem_id,reserve_num,room_num,reserve_date,reserve_state,checkindate,checkoutdate,adult_cnt,child_cnt,infant_cnt,extrabed_cnt,breakfast_cnt,add_requests
		from reserve r where mem_id = #{param1} order by reserve_idx
	
	</select>

	<select id="reserInfo" resultType="co.kr.hotel.dto.MypageDTO">
		<!-- select * from reserve r  where mem_id = #{param1} and reserve_num = #{param2} order by reserve_date,reserve_idx desc limit 1 -->
		select * from reserve r  where mem_id = #{param1} and reserve_idx = #{param2} order by reserve_date,reserve_idx
	</select>

	<select id="payDto" resultType="co.kr.hotel.dto.ReserveDTO">
		select r.*,pay_idx,r.reserve_idx,pay_num,AES_DECRYPT(UNHEX(credit_num), SHA2('a-key',512))AS credit_num,pay_date,pay_state,credit_validity,credit_type,pay_price,pay_mileage,amount 
		from pay p inner join reserve r on r.reserve_idx = p.reserve_idx 
		where reserve_num = #{param1}
		order by pay_date desc limit 1
	</select>


	<select id="resernum" resultType="co.kr.hotel.dto.ReserveDTO">
		select distinct reserve_num 
		from reserve r where mem_id = #{param1} 
	</select>


<!-- 20220315 예약 리스트 보기 SI - START -->
	<select id="myReserveAll" resultType="co.kr.hotel.dto.ReserveDTO">
		SELECT r.*, sum(p.amount) as reserve_amount, ro.room_type_name 
		FROM (
			SELECT *
		    FROM reserve
		    ORDER BY reserve_date desc, reserve_state desc
		    LIMIT 18446744073709551615
		) as r
		left outer join pay p 
		on r.reserve_idx = p.reserve_idx 
		left outer join room ro
		on r.room_num = ro.room_num
			GROUP BY reserve_num
			having mem_id = #{param1}
			order by reserve_date desc
	</select>
	
	<select id="myReserveParts" resultType="co.kr.hotel.dto.ReserveDTO">
		select r.reserve_num, r.mem_id, r.reserve_state, count(*) as reserve_room_cnt
		from reserve r 
		group by reserve_num, reserve_state 
		having mem_id = #{param1} and reserve_state = 1
	</select>
<!-- 20220315 예약 리스트 보기 SI - END -->

<!-- 20220315 마이페이지 마일리지 리스트 보기 유선화 - START -->


	<select id="myPagemilelist" resultType="co.kr.hotel.dto.MypageDTO">
	
		select mileage_idx,mem_id,mileage_price,mileage_date,mileage_useable from mileage m where mem_id = #{param1}

	
	</select>

	<!-- 마이페이지 마일리지 리스트 페이징 -->
	<select id="milelistCount" parameterType="co.kr.hotel.dto.PageDto" resultType="int">
 	select count(*) from mileage	
	where mem_id = #{param1}
	</select>
	<select id="milelistInfo" parameterType="co.kr.hotel.dto.PageDto" resultType="co.kr.hotel.dto.MemberDTO">
	 	select * from mileage
		where mem_id=#{param3}
	 	order by mileage_date desc
	 	limit #{param1}, #{param2}
	</select> 

<!-- 20220315 마이페이지 마일리지 리스트 보기 유선화 - END -->


	<select id="mypagedto" resultType="co.kr.hotel.dto.MypageDTO">
		select mileage_useable,mem_id from mileage
		where mem_id =#{param1} 
		order by mileage_date desc limit 1 
	</select>

	<select id="memberlist" resultType="co.kr.hotel.dto.MemberDTO">
		select mem_id,AES_DECRYPT(UNHEX(credit_num), SHA2('a-key',512))as credit_num,mem_grade,mem_pw,mem_name_kr,mem_name_en,mem_birth,mem_phone,mem_email,credit_num,credit_validity,credit_type           
		from member
		where mem_id = #{param1} 
		
	</select>







</mapper>