<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC	"-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="co.kr.hotel.dao.ReserveDAO">


	<select id="toReservelist" resultType="co.kr.hotel.dto.RoomDTO">
	
		SELECT distinct r.room_num,r.room_type, r.room_price, r.room_type_name,p.room_img FROM room r inner join photo p ON r.room_num = p.room_num 
		WHERE r.room_num not in 
		(select room_num from reserve
		WHERE checkindate  BETWEEN #{param1} AND #{param2} OR
		checkoutdate  BETWEEN #{param1} AND #{param2} OR
		(checkindate  &gt;= #{param1} AND checkoutdate  &lt;= #{param2}) and reserve_state = 1) 
		and 
		(room_img = '디럭스1.png' and bed_type = 1 
		or room_img = '프리미어1.png' and bed_type = 1 
		or room_img = '패밀리1.png' and bed_type = 1 
		or room_img = '스위트1.png' and bed_type = 1)
		order by r.room_type,p.room_img;
	</select>

	
	<select id="reservation_option" resultType="hashmap">
		SELECT * FROM room_option
	</select>
	
	<select id="reservation_product" resultType="hashmap">
		SELECT * FROM product
	</select>
	
	<select id="useable" resultType="int">
		SELECT m.mileage_useable FROM mileage m WHERE mem_id = #{param1} order by mileage_date desc limit 1;
	</select>

	 
	 <insert id="roomOne" 
	 	useGeneratedKeys="true"
	 	keyProperty="reserve_idx"
	 	keyColumn="reserve_idx"
	 	parameterType="co.kr.hotel.dto.ReserveDTO">
	 		
		insert into reserve (mem_id,reserve_num,room_num,reserve_date,reserve_state,checkindate,checkoutdate,adult_cnt,extrabed_cnt,breakfast_cnt,add_requests)
		values(#{mem_id},#{reserve_num},#{room_num},#{reserve_date},#{reserve_state},#{checkindate},#{checkoutdate},#{adult_cnt},#{extrabed_cnt},#{breakfast_cnt},#{add_requests})
	 	
	 </insert>
	 
	 <insert id="roomOneCart">
	 	INSERT INTO cart(reserve_idx,product_cnt,product_num)VALUES(#{param1},#{param2},#{param3})
	 </insert>
	 
	 <insert id="buyMileageminus">
	 INSERT INTO mileage(mem_id,mileage_price,mileage_useable)VALUES(#{param1},#{param2},#{param3})
	 </insert>           
	 
	 <select id="product_price" resultType="int">
		select p.product_price from product p where product_num = #{param1}
	</select>
	
	<select id="reservation_memInfo" resultType="co.kr.hotel.dto.MemberDTO">
		select mem_id,AES_DECRYPT(UNHEX(credit_num), SHA2('a-key',512))as credit_num,mem_grade,mem_name_kr,mem_name_en,mem_phone,mem_email,credit_num,credit_validity,credit_type           
		from member
		where mem_id = #{param1} 
	</select>
	
	
	<select id="roomIdx" resultType="co.kr.hotel.dto.RoomDTO">
			
		SELECT r.room_num FROM room r 
			WHERE r.room_num not in 
			(select room_num from reserve 
			WHERE checkindate  BETWEEN #{checkindate} AND #{checkoutdate} OR
			checkoutdate  BETWEEN #{checkindate} AND #{checkoutdate} OR
			(checkindate  &gt; #{checkindate} AND checkoutdate  &lt; #{checkoutdate})and reserve_state = 1) and r.room_type = #{room_type} and r.bed_type = #{bed_type} order by r.room_num limit #{roomCnt}

	          
	</select>
	
	
</mapper>
